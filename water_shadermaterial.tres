[gd_resource type="ShaderMaterial" load_steps=2 format=2]

[sub_resource type="Shader" id=1]
code = "shader_type spatial;

uniform float time = 0.0;
uniform vec4 deep_color : hint_color = vec4(0.0, 0.2, 1.0, 1.0);
uniform vec4 shallow_color : hint_color = vec4(0.0, 0.2, 1.0, 1.0);
uniform float beer_factor = 0.1;
uniform float color_beer_factor = 0.1;
uniform float amount : hint_range(0.2, 1.5) = 0.8;
uniform vec4 waveA = vec4(1,0,0.5,10);
uniform vec4 waveB = vec4(0,1,0.25,20);
uniform vec4 waveC = vec4(1,1,0.15,10);
uniform vec4 waveD = vec4(1,1,0.15,50);

float PI(){
	return 3.14159265358979323846264338327950288419716939937510582097494459230781640628;
}

vec3 GerstnerWave(vec4 wave, vec3 p, inout vec3 tangent, inout vec3 binormal){
	float steepness = wave.z;
	float wavelength = wave.w;
	float k = 2.0 * PI() / wavelength;
	float c = sqrt(9.8/k);
	vec2 d = normalize(wave.xy);
	float f = k * (dot(d, p.xz) - c* time);
	float a = steepness / k;
	
	tangent += vec3(1.0 - d.x * d.x * (steepness * sin(f)),
						d.x * (steepness * cos(f)),
						-d.x * d.y * (steepness * sin(f))
						);
	binormal += vec3(- d.x * d.y * (steepness * sin(f)),
						d.x * (steepness * cos(f)),
						1.0 - d.x * d.x  * (steepness * sin(f))
						);
	
	return vec3(d.x * (a * cos(f)),
				a * sin(f),
				d.y * (a * cos(f))
	);
}

void vertex(){
	
	vec3 tangent = vec3(1,0,0);
	vec3 binormal = vec3(0,0,1);
	
	VERTEX += GerstnerWave(waveA, VERTEX, tangent, binormal);
	//VERTEX += GerstnerWave(waveB, VERTEX, tangent, binormal);
	//VERTEX += GerstnerWave(waveC, VERTEX, tangent, binormal);
	//VERTEX += GerstnerWave(waveD, VERTEX, tangent, binormal);
	NORMAL = normalize(cross(binormal,tangent));
}

void fragment(){
	
	//NORMAL = normalize(cross(dFdx(VERTEX),dFdy(VERTEX)));
	METALLIC = 0.9;
	SPECULAR = 0.9;
	ROUGHNESS = 0.2;
	
	float depth = texture(DEPTH_TEXTURE, SCREEN_UV).r;
	depth = depth * 2.0 - 1.0;
	depth = PROJECTION_MATRIX[3][2] / (depth + PROJECTION_MATRIX[2][2]);
	depth += VERTEX.z;
	
	//beers law
	float beer_depth = exp(-depth * beer_factor);
	float color_depth = exp(-depth * color_beer_factor);
	//ALBEDO = vec3(depth,depth,depth);
	ALPHA = clamp(1.0 - beer_depth, 0.0, 1.0);
	//ALBEDO = deep_color.xyz;
	ALBEDO = mix(deep_color.xyz, shallow_color.xyz, clamp(color_depth, 0.0, 1.0));
}"

[resource]
shader = SubResource( 1 )
shader_param/time = 0.0
shader_param/deep_color = Color( 0.129412, 0.317647, 0.533333, 1 )
shader_param/shallow_color = Color( 0, 0.788235, 1, 1 )
shader_param/beer_factor = 1.46
shader_param/color_beer_factor = 0.05
shader_param/amount = 0.8
shader_param/waveA = Plane( 0.122, 0.164, 0.2, 10 )
shader_param/waveB = Plane( 0.313, 0.621, 0.2, 10 )
shader_param/waveC = Plane( 0.818, 1.112, 0.25, 25 )
shader_param/waveD = Plane( 1, 1, 0.3, 50 )
